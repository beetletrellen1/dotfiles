#!/bin/bash

# Time in seconds
short_break_in_seconds=14
long_break_in_seconds=$((8*60))
short_interval_in_seconds=$((4*60))
long_interval_in_seconds=$((50*60))
log_file=~/tmp/event.log

break_timer() {
    local i=0
    local last_key=$(last_key)
    local restart=false

    while [ $i -lt $1 ]; do
        if [[ "$last_key" != $(last_key) ]]; then
            last_key=$(last_key)
            restart=true
            break
        fi
        progress=$(echo "scale=2;$i*100/$1" | bc)
        time_left=$(($1-$i))
        echo "# $(format_time $time_left)"
        echo "$progress"  # Give correct percentage
        sleep 1
        i=$(( i+1 ))
    done

    if [[ restart = true ]]; then
        break_timer $1
    fi
}

last_key() {
    hex=$(tail -2 "$log_file" | head -1)
    IFS=' ' read -ra keys <<< "$hex"
    echo "${keys[0]}"
}

format_time() {
    minutes=$(($1/60))
    seconds=$(($1%60))

    echo $(printf "%2d:%02d" $minutes $seconds)
}

short_break() {
    local pid_keylogger=$(log_key_input)

    break_timer $short_break_in_seconds | alert_box "Short Break"

    cp /dev/null "$log_file"
    kill $pid_keylogger
}

long_break() {
    local pid_keylogger=$(log_key_input)

    break_timer $long_break_in_seconds | alert_box "Long Break"

    cp /dev/null "$log_file"
    kill $pid_keylogger
}

alert_box() {
    zenity \
        --progress \
        --title="$1(ESC to Postpone)" \
        --auto-close \
        --auto-kill \
        --no-cancel \
        --ok-label='Postpone' \
        --class='StopRSI' \
        --name='StopRSI' \
        --width=200
}

main() {
    i=1
    while [ $i ]; do
        if [[ $(( $i % $long_interval_in_seconds )) == 0 ]]
        then
            long_break
        elif [[ $(( $i % $short_interval_in_seconds )) == 0 ]]
        then
            short_break
        fi
        sleep 1;

        i=$(( i+1 ))
    done
}

cleanup() {
    echo ""
    echo "Closing"
    echo "..."
    killall hexdump --quiet
    exit $?
}

log_key_input() {
    cat /dev/input/event0 | hexdump > "$log_file" &
    echo "$!"
}

trap "cleanup" 2

main
